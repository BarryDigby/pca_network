---
title: "LNCaP_meta"
author: "Barry"
date: "2023-09-26"
output: html_document
---

# LNCaP meta analysis

Using the ceRNA network derived from the TCGA, we are interested in its expression in the LNCaP cell lines (circRNA, miRNA and mRNA). This is the only dataset where all three RNA biotypes are represented.

```{R}
library(GEOquery)
library(limma)
library(pheatmap)
library(dplyr)
library(tidyr)
library(ggpubr)

nodelist = read.csv("/data/github/pca_network/results/prognostic_nodelist.csv", header=T, sep="\t")
mrnas = c("REG4", "JAG2", "CTHRC1", "SLC2A4")
mirnas = nodelist$id[grepl("hsa-miR", nodelist$id)]
circrnas = nodelist$id[grepl("hsa_circ", nodelist$id)]
rm(nodelist)
## identify parent genes
prog_net = read.csv("/data/github/pca_network/results/prognostic_edgelist.csv", sep="\t", header=T)
prog_circ = prog_net$source[grep("hsa_circ", prog_net$source)]
prog_circ = unique(prog_circ)
limma_circs = read.csv("/data/github/pca_network/results/circrna_intersection.txt", sep="\t", header=T)
limma_circs = limma_circs[which(limma_circs$circbaseID %in% prog_circ),]
circ_parent = limma_circs[, c("circbaseID", "GeneSymbol")]
```

# format circRNA

```{R}
gset <- getGEO("GSE118959", GSEMatrix =TRUE, AnnotGPL=FALSE)
if (length(gset) > 1) idx <- grep("GPL21825", attr(gset, "names")) else idx <- 1
gset <- gset[[idx]]

# make proper column names to match toptable 
fvarLabels(gset) <- make.names(fvarLabels(gset))

meta <- data.frame(Treatment = c(rep("Control", 3), rep("Clone1", 3), rep("Clone9", 3)),
                   Replicate = rep(c("1", "2", "3"), 3))
rownames(meta) = colnames(exprs(gset))
exp = as.data.frame(exprs(gset))

probes = read.table("/data/github/pca_network/data/arraystar_updated_circbaseID.csv", sep="\t", header=T)
probes = probes[which(probes$circbaseID %in% circ_parent$circbaseID),]

exp = exp[which(rownames(exp) %in% probes$probeID),]

# reformat 
exp = merge(exp, probes[,c("probeID", "circbaseID")], by.x=0, by.y="probeID")
exp = tibble::column_to_rownames(exp, "circbaseID")
exp = exp[,2:ncol(exp)]

colnames(exp) = c("Ctl_1", "Ctl_2", "Ctl_3", "C1_1", "C1_2", "C1_3", "C9_1", "C9_2", "C9_3")
circ_mat = exp

rm(gset, meta, probes, exp)
```

# format miRNA

```{R}
mat = read.csv("/data/LNCaP_miRNA/Trim_Experiment/mirtop/mirna.tsv", sep="\t", header=T, row.names="miRNA")
# dump old Clone1 samples
mat = mat[,-c(2,5)]
meta = data.frame(row.names = colnames(mat),
                  group = factor(c(rep("Clone_1", 3), rep("Clone_9", 3), rep("Control", 3))),
                  replicates = factor(rep(seq(1:3), 3)),
                  batch = factor(c( rep("A", 3), rep("B", 6))) )

design = model.matrix( ~ 0 + group + replicates + batch, data = meta )                 

y <- edgeR::DGEList(mat)
keep <- edgeR::filterByExpr(y, design)
y <- y[keep, ]

# normalize and run voom transformation
y <- edgeR::calcNormFactors(y)
logcpm <- edgeR::cpm(y, normalized.lib.sizes = T, log=TRUE)

mirna_mat = logcpm[mirnas, ]
colnames(mirna_mat) = c("C1_1", "C1_2", "C1_3", "C9_1", "C9_2", "C9_3", "Ctl_1", "Ctl_2", "Ctl_3")
mirna_mat = as.data.frame(mirna_mat)
rm(design, logcpm, mat, meta, y) 
```

# format genes

```{R}
counts = read.table("/data/github/pca_network/mrna/LNCaP/mRNA_counts.txt", header=T, sep="\t", row.names = "gene_symbols")
meta = data.frame(row.names = colnames(counts),
                  group = factor(c(rep("Clone_1", 3), rep("Clone_9", 3), rep("Control", 3))),
                  replicate = factor(rep(seq(1:3), 3)))

design = model.matrix( ~ 0 + group + replicate, data = meta )                 

y <- edgeR::DGEList(counts)
keep <- edgeR::filterByExpr(y, design)
y <- y[keep, ]

# normalize and run voom transformation
y <- edgeR::calcNormFactors(y)
logcpm <- edgeR::cpm(y, normalized.lib.sizes = T, log=T)

mrna_mat = logcpm[rownames(logcpm) %in% circ_parent$GeneSymbol, ]
colnames(mrna_mat) = c("C1_1", "C1_2", "C1_3", "C9_1", "C9_2", "C9_3", "Ctl_1", "Ctl_2", "Ctl_3")
mrna_mat = as.data.frame(mrna_mat)

rm(counts, keep,  meta, logcpm, y, design)
```


## correlate circrna, gene expression across the levels of ENZ resistance. 

```{R}
mat = rbind(circ_mat, mrna_mat)
mat = as.data.frame(t(mat))
mat$exp = c(rep("CTL", 3), rep("C1", 3), rep("C9", 3))

wide = mat %>%
  pivot_longer(cols = colnames(mat[1:ncol(mat)-1]), names_to = "RNA", values_to = "Expression")


library(ggpubr)


ggscatter(mat, x="FN1", y="hsa_circ_0058097", add = "reg.line", cor.coef = T)
```




# heatmap

```{R, fig.height=6}
mat = rbind(circ_mat, mirna_mat, mrna_mat)

mat = t(scale(t(mat), scale = T, center = T))

mat = mat[, c("Ctl_1", "Ctl_2", "Ctl_3", "C9_1", "C9_2", "C9_3", "C1_1", "C1_2", "C1_3")]

pheatmap(mat, cluster_rows = F, cluster_cols = F, scale = "none", gaps_row = c(27, 32), gaps_col = c(3, 6))

```


# boxplots

```{R}
mat = as.data.frame(t(mat))
mat$exp = c(rep("CTL", 3), rep("C1", 3), rep("C9", 3))

wide_df = mat %>%
  pivot_longer(cols = colnames(mat[1:ncol(mat)-1]), names_to = "Variable", values_to = "Score")

df = wide_df[which(wide_df$Variable=="hsa-miR-26a-5p"),]

signif_yaxis = max(df$Score) + (max(df$Score)*0.10)
signif_yaxis2 = max(df$Score) + (max(df$Score)*0.05)

ggboxplot(df, x = "exp", y = "Score",
                 fill = "exp", color = "black", palette = "jco",
                 ylab ="Normalized Counts", title = "hsa-miR-26a-5p Expression",
                 xlab="", add = c("dotplot"),
                 add.params = list(size=0.75, jitter=0.01),
                 legend = "none", bxp.errorbar = T,
                 bxp.errorbar.width = 0.2, width=0.3, ggtheme = theme_classic()) +
                 theme(axis.text.x = element_text( colour = "black", size=14)) +
                 theme(axis.title.y = element_text( colour = "black", size=14)) +
                 theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
                 rotate_x_text(angle = 45) +
                 geom_hline(yintercept = mean(df$Score), linetype = 2) +
                 stat_compare_means(method = "anova", label.y = signif_yaxis) +        
                 stat_compare_means(label = "p.signif", method = "t.test",
                                    ref.group = ".all.", label.y = signif_yaxis2)
```